# Проверка работы API

## Структура API Routes

Все API endpoints находятся в `src/app/api/`:

### 1. Challenges
- ✅ `GET /api/challenges/` - получить челленджи пользователя
- ✅ `POST /api/challenges/` - создать новый челлендж
- ✅ `GET /api/challenges/[id]` - получить конкретный челлендж
- ✅ `GET /api/challenges/global` - получить глобальные челленджи
- ✅ `POST /api/challenges/[id]/assign` - назначить челлендж пользователю
- ✅ `PUT /api/challenges/[id]/toggle` - переключить статус выполнения

### 2. Users
- ✅ `GET /api/users/[id]` - получить профиль пользователя
- ✅ `POST /api/users/` - создать нового пользователя

### 3. Leaderboard
- ✅ `GET /api/leaderboard/` - получить таблицу лидеров

### 4. AI
- ✅ `POST /api/ai/generate-challenge` - сгенерировать челлендж с помощью AI

## Хранение данных

Все данные хранятся в памяти через глобальные переменные:
- `global.challenges` - все челленджи (включая глобальные)
- `global.userChallenges` - связь пользователей и челленджей
- `global.users` - пользователи

**Важно**: Данные сохраняются между запросами в рамках одного процесса сервера, но теряются при перезапуске.

## Интеграция с фронтендом

API клиент (`src/lib/api.ts`) автоматически использует:
- `/api` если `NEXT_PUBLIC_API_URL` не установлен (работает с Next.js API Routes)
- Или внешний URL если установлен `NEXT_PUBLIC_API_URL`

## Поток работы

1. **Инициализация пользователя**:
   - При загрузке страницы вызывается `apiClient.getUser('user1')`
   - Если пользователя нет, создается через `apiClient.createUser()`

2. **Загрузка челленджей**:
   - `apiClient.getChallenges('user1')` - получает назначенные челленджи
   - `apiClient.getGlobalChallenges('user1')` - получает глобальные челленджи

3. **Назначение глобального челленджа**:
   - Пользователь нажимает "Принять" на глобальном челлендже
   - Вызывается `apiClient.assignChallenge(challengeId, 'user1')`
   - Челлендж добавляется в `userChallenges`

4. **Выполнение челленджа**:
   - Пользователь нажимает на челлендж
   - Вызывается `apiClient.toggleChallenge(challengeId, 'user1')`
   - Обновляется статус `completed` и статистика пользователя

5. **Создание нового челленджа**:
   - Пользователь создает челлендж через форму
   - Вызывается `apiClient.createChallenge(challengeData)`
   - Челлендж добавляется в `challenges` и автоматически назначается пользователю

## Потенциальные проблемы

1. **Глобальные челленджи не инициализируются в toggle**:
   - ✅ Исправлено: добавлена функция `initGlobalChallengesIfNeeded()` в toggle endpoint

2. **Данные теряются при перезапуске**:
   - Это нормально для in-memory хранилища
   - В production можно подключить реальную БД (PostgreSQL через DigitalOcean)

3. **Синхронизация данных между routes**:
   - ✅ Все routes используют одни и те же глобальные переменные
   - Данные синхронизированы автоматически

## Проверка работы

Для проверки локально:
```bash
npm install
npm run dev
```

Затем открыть:
- http://localhost:3000 - фронтенд
- http://localhost:3000/api/challenges/global - проверить API напрямую

Для проверки на DigitalOcean:
- Приложение автоматически соберется и запустится
- Все API routes доступны через `/api/...`

